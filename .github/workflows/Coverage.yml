# =============================================================================
# Coverage Workflow - Code Coverage Generation & Verification
# =============================================================================
# Generates coverage reports per module using Kover, aggregates results,
# enforces 80% minimum global coverage, and uploads to Codecov.
# Triggers: After Test workflow completes, manual dispatch
# =============================================================================

name: Coverage

on:
  workflow_run:
    workflows: [Test]
    types: [completed]
    branches: [master, develop, staging]
  pull_request:
    branches: [master, develop, staging]
    paths:
      - '**.kt'
      - '**.kts'
      - 'gradle/**'
  workflow_dispatch:

concurrency:
  group: coverage-${{ github.event.pull_request.number || github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ===========================================================================
  # Per-Module Coverage - Generate coverage for each module
  # ===========================================================================
  module-coverage:
    name: ğŸ“Š Coverage - ${{ matrix.module }}
    runs-on: ubuntu-latest
    # Skip if Test workflow failed (when triggered by workflow_run)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        module: [domain, application, infrastructure]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the commit that triggered the Test workflow
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: ğŸ§ª Run tests with coverage for ${{ matrix.module }}
        run: ./gradlew :${{ matrix.module }}:test :${{ matrix.module }}:koverXmlReport :${{ matrix.module }}:koverHtmlReport

      - name: ğŸ“Š Upload module coverage report (XML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml-${{ matrix.module }}
          path: ${{ matrix.module }}/build/reports/kover/report.xml
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“Š Upload module coverage report (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-${{ matrix.module }}
          path: ${{ matrix.module }}/build/reports/kover/html/
          retention-days: 14
          if-no-files-found: warn

  # ===========================================================================
  # Global Coverage Verification - Enforce 80% minimum
  # ===========================================================================
  verify-coverage:
    name: âœ… Verify Global Coverage
    runs-on: ubuntu-latest
    needs: [module-coverage]

    outputs:
      coverage-percentage: ${{ steps.coverage-check.outputs.coverage }}
      coverage-passed: ${{ steps.coverage-check.outputs.passed }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: ğŸ§ª Run all tests with global coverage
        run: ./gradlew test koverXmlReport koverHtmlReport

      - name: âœ… Verify minimum coverage (80%)
        id: coverage-check
        run: |
          # Run koverVerify and capture result
          if ./gradlew koverVerify; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Coverage verification passed!"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Coverage verification failed - below 80% threshold"
            exit 1
          fi

      - name: ğŸ“Š Upload global coverage report (XML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml-global
          path: build/reports/kover/report.xml
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“Š Upload global coverage report (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-global
          path: build/reports/kover/html/
          retention-days: 14
          if-no-files-found: warn

  # ===========================================================================
  # Coverage Summary - Generate PR comment and upload to Codecov
  # ===========================================================================
  coverage-summary:
    name: ğŸ“‹ Coverage Summary
    runs-on: ubuntu-latest
    needs: [module-coverage, verify-coverage]
    if: always() && needs.module-coverage.result == 'success'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: ğŸ“¥ Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: 'coverage-xml-*'
          path: coverage-reports
          merge-multiple: false

      # UPDATED STEP: Using v5 with simplified configuration
      - name: ğŸ“Š Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: |
            coverage-reports/coverage-xml-domain/report.xml,
            coverage-reports/coverage-xml-application/report.xml,
            coverage-reports/coverage-xml-infrastructure/report.xml,
            coverage-reports/coverage-xml-global/report.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: ğŸ“ Generate coverage summary
        id: coverage-summary
        run: |
          echo "## ğŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check verification status
          if [ "${{ needs.verify-coverage.outputs.coverage-passed }}" == "true" ]; then
            echo "âœ… **Global coverage meets the 80% minimum threshold**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Global coverage is below the 80% minimum threshold**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Module Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
          echo "| Application | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
          echo "| **Global** | ${{ needs.verify-coverage.outputs.coverage-passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ˆ View detailed coverage on [Codecov](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Add PR comment with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const verifyPassed = '${{ needs.verify-coverage.outputs.coverage-passed }}' === 'true';

            const body = `## ğŸ“Š Code Coverage Report

            ${verifyPassed ? 'âœ… **Global coverage meets the 80% minimum threshold**' : 'âŒ **Global coverage is below the 80% minimum threshold**'}

            ### Module Coverage
            | Module | Status |
            |--------|--------|
            | Domain | âœ… Generated |
            | Application | âœ… Generated |
            | Infrastructure | âœ… Generated |
            | **Global** | ${verifyPassed ? 'âœ… Passed' : 'âŒ Failed'} |

            ğŸ“ˆ View detailed coverage on [Codecov](https://codecov.io/gh/${{ github.repository }})

            ---
            <sub>Coverage reports are available as workflow artifacts for 30 days.</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“Š Code Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ===========================================================================
  # Store Coverage for Code Analysis - Artifacts for CodeQL
  # ===========================================================================
  store-for-analysis:
    name: ğŸ“¦ Store for Code Analysis
    runs-on: ubuntu-latest
    needs: [verify-coverage]
    if: always() && needs.verify-coverage.result == 'success'

    steps:
      - name: ğŸ“¥ Download global coverage XML
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml-global
          path: coverage-for-analysis

      - name: ğŸ“¥ Download module coverage XMLs
        uses: actions/download-artifact@v4
        with:
          pattern: 'coverage-xml-*'
          path: coverage-for-analysis/modules
          merge-multiple: false

      - name: ğŸ“¦ Upload coverage for CodeQL analysis
        uses: actions/upload-artifact@v4
        with:
          name: coverage-for-codeql
          path: coverage-for-analysis/
          retention-days: 90
          if-no-files-found: warn
