# =============================================================================
# Reusable Workflow - Environment Configuration
# =============================================================================
# Loads secrets and variables from GitHub Environments and runs commands.
#
# Automatic environment selection:
#   - master       ‚Üí prod
#   - staging      ‚Üí staging
#   - develop      ‚Üí test
#   - PR / other   ‚Üí development
#
# Usage:
#   jobs:
#     test:
#       uses: ./.github/workflows/env.yml
#       with:
#         command: ./gradlew test
#       secrets: inherit
#
# Setup required in GitHub:
#   1. Create 4 environments: development, test, staging, prod
#   2. Add secrets to each: OPENAI_API_KEY, JWT_SECRET
#   3. Add variables to each: APP_NAME, SERVER_PORT, LOG_LEVEL_APP, etc.
# =============================================================================

name: Environment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment override (auto-detected from branch if not set)'
        required: false
        type: string
      command:
        description: 'Command to run'
        required: true
        type: string
      java-version:
        description: 'Java version'
        required: false
        type: string
        default: '21'

    outputs:
      environment:
        description: 'Selected environment name'
        value: ${{ jobs.resolve.outputs.environment }}

jobs:
  # ===========================================================================
  # Determine which environment to use
  # ===========================================================================
  resolve:
    name: üîç Resolve Environment
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ steps.determine.outputs.environment }}

    steps:
      - name: üîç Determine environment from branch
        id: determine
        run: |
          if [[ -n "${{ inputs.environment }}" ]]; then
            SELECTED_ENV="${{ inputs.environment }}"
          else
            BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
            case "$BRANCH" in
              master|main) SELECTED_ENV="prod" ;;
              staging)     SELECTED_ENV="staging" ;;
              develop)     SELECTED_ENV="test" ;;
              *)           SELECTED_ENV="development" ;;
            esac
          fi
          echo "environment=$SELECTED_ENV" >> $GITHUB_OUTPUT
          echo "‚úÖ Selected environment: $SELECTED_ENV"

  # ===========================================================================
  # Run command with environment
  # ===========================================================================
  run:
    name: üöÄ Run
    runs-on: ubuntu-latest
    needs: resolve
    environment: ${{ needs.resolve.outputs.environment }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: üêò Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: üöÄ Run command
        run: ${{ inputs.command }}
        env:
          # ===========================================
          # Secrets (from GitHub Environment)
          # ===========================================
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

          # ===========================================
          # Variables (from GitHub Environment)
          # ===========================================
          # Application
          APP_ENVIRONMENT: ${{ vars.APP_ENVIRONMENT || needs.resolve.outputs.environment }}
          APP_NAME: ${{ vars.APP_NAME || 'image-rag' }}
          SERVER_PORT: ${{ vars.SERVER_PORT || '8080' }}
          DEVTOOLS_ENABLED: ${{ vars.DEVTOOLS_ENABLED || 'false' }}

          # Logging
          LOG_LEVEL_ROOT: ${{ vars.LOG_LEVEL_ROOT || 'WARN' }}
          LOG_LEVEL_APP: ${{ vars.LOG_LEVEL_APP || 'INFO' }}
          LOG_LEVEL_SPRING: ${{ vars.LOG_LEVEL_SPRING || 'WARN' }}
          LOG_LEVEL_WEB: ${{ vars.LOG_LEVEL_WEB || 'WARN' }}
          LOG_LEVEL_SECURITY: ${{ vars.LOG_LEVEL_SECURITY || 'WARN' }}

          # Error handling
          ERROR_INCLUDE_MESSAGE: ${{ vars.ERROR_INCLUDE_MESSAGE || 'always' }}
          ERROR_INCLUDE_BINDING_ERRORS: ${{ vars.ERROR_INCLUDE_BINDING_ERRORS || 'always' }}
          ERROR_INCLUDE_STACKTRACE: ${{ vars.ERROR_INCLUDE_STACKTRACE || 'never' }}
          ERROR_INCLUDE_EXCEPTION: ${{ vars.ERROR_INCLUDE_EXCEPTION || 'false' }}
