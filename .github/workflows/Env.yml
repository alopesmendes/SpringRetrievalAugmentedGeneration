# =============================================================================
# Reusable Workflow - Environment Configuration
# =============================================================================
# Resolves the environment based on branch and optionally runs commands.
#
# Automatic environment selection:
#   - master       ‚Üí prod
#   - staging      ‚Üí staging
#   - develop      ‚Üí test
#   - PR / other   ‚Üí development
#
# Usage (Environment resolution only):
#   jobs:
#     env:
#       uses: ./.github/workflows/Env.yml
#       secrets: inherit
#
# Usage (With command execution):
#   jobs:
#     test:
#       uses: ./.github/workflows/Env.yml
#       with:
#         command: ./gradlew test
#       secrets: inherit
#
# Setup required in GitHub:
#   1. Create 4 environments: development, test, staging, prod
#   2. Add secrets to each: OPENAI_API_KEY, JWT_SECRET
#   3. Add variables to each: APP_NAME, SERVER_PORT, LOG_LEVEL_APP, etc.
# =============================================================================

name: Environment

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment override (auto-detected from branch if not set)'
        required: false
        type: string
      command:
        description: 'Command to run (optional)'
        required: false
        type: string
        default: ''
      java-version:
        description: 'Java version'
        required: false
        type: string
        default: '21'

    outputs:
      environment:
        description: 'Selected environment name'
        value: ${{ jobs.resolve.outputs.environment }}
      app_environment:
        description: 'APP_ENVIRONMENT variable'
        value: ${{ jobs.resolve.outputs.environment }}

jobs:
  # ===========================================================================
  # Determine which environment to use
  # ===========================================================================
  resolve:
    name: üîç Resolve Environment
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ steps.determine.outputs.environment }}

    steps:
      - name: üîç Determine environment from branch
        id: determine
        env:
          INPUT_ENVIRONMENT: ${{ inputs.environment }}
        run: |
          if [[ -n "${INPUT_ENVIRONMENT}" ]]; then
            SELECTED_ENV="${INPUT_ENVIRONMENT}"
          else
            BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
            case "$BRANCH" in
              master|main) SELECTED_ENV="prod" ;;
              staging)     SELECTED_ENV="staging" ;;
              develop)     SELECTED_ENV="test" ;;
              *)           SELECTED_ENV="development" ;;
            esac
          fi
          echo "environment=$SELECTED_ENV" >> $GITHUB_OUTPUT
          echo "‚úÖ Selected environment: $SELECTED_ENV"

  # ===========================================================================
  # Run command with environment (optional)
  # ===========================================================================
  run:
    name: üöÄ Run
    runs-on: ubuntu-latest
    needs: resolve
    if: ${{ inputs.command != '' }}
    environment: ${{ needs.resolve.outputs.environment }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ‚òï Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: üêò Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5

      - name: üöÄ Run command
        run: |
          bash -lc "$INPUT_COMMAND"
        env:
          INPUT_COMMAND: ${{ inputs.command }}
          # ===========================================
          # Secrets (from GitHub Environment)
          # ===========================================
          #OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          MONGODB_CONNECTION_STRING: ${{ secrets.MONGODB_CONNECTION_STRING }}

          # ===========================================
          # Variables (from GitHub Environment)
          # ===========================================
          # Application
          APP_ENVIRONMENT: ${{ vars.APP_ENVIRONMENT || needs.resolve.outputs.environment }}
          APP_NAME: ${{ vars.APP_NAME || 'image-rag' }}
          SERVER_PORT: ${{ vars.SERVER_PORT || '8080' }}
          DEVTOOLS_ENABLED: ${{ vars.DEVTOOLS_ENABLED || 'false' }}

          # Render
          RENDER_SERVICE_ID: ${{ vars.RENDER_SERVICE_ID }}
          RENDER_DOMAIN: ${{ vars.RENDER_DOMAIN || 'https://image-rag-dev.onrender.com' }}

          # Actuator
          ACTUATOR_ENDPOINTS: ${{ vars.ACTUATOR_ENDPOINTS || '*' }}
          ACTUATOR_HEALTH_COMPONENTS: ${{ vars.ACTUATOR_HEALTH_COMPONENTS || 'always' }}
          ACTUATOR_HEALTH_DB: ${{ vars.ACTUATOR_HEALTH_DB || 'false' }}
          ACTUATOR_HEALTH_DETAILS: ${{ vars.ACTUATOR_HEALTH_DETAILS || 'always' }}
          ACTUATOR_HEALTH_MONGO: ${{ vars.ACTUATOR_HEALTH_MONGO || 'false' }}

          # Logging
          LOG_LEVEL_ROOT: ${{ vars.LOG_LEVEL_ROOT || 'WARN' }}
          LOG_LEVEL_APP: ${{ vars.LOG_LEVEL_APP || 'INFO' }}
          LOG_LEVEL_SPRING: ${{ vars.LOG_LEVEL_SPRING || 'WARN' }}
          LOG_LEVEL_WEB: ${{ vars.LOG_LEVEL_WEB || 'WARN' }}
          LOG_LEVEL_SECURITY: ${{ vars.LOG_LEVEL_SECURITY || 'WARN' }}

          # Error handling
          ERROR_INCLUDE_STACKTRACE: ${{ vars.ERROR_INCLUDE_STACKTRACE || 'never' }}
          ERROR_INCLUDE_EXCEPTION: ${{ vars.ERROR_INCLUDE_EXCEPTION || 'false' }}

          # Swagger
          SWAGGER_ENABLED: ${{ vars.SWAGGER_ENABLED || 'true' }}
          SWAGGER_TRY_IT_OUT: ${{ vars.SWAGGER_TRY_IT_OUT || 'true' }}
