# =============================================================================
# Analysis Workflow - Security & Code Quality Scanning
# =============================================================================
# Runs deep static analysis using CodeQL (Security) and Detekt (Code Smells).
# Results are uploaded to GitHub's Security > Code Scanning tab.
#
# Triggers:
#   - Called from CI.yml (workflow_call)
#   - Weekly schedule (Sunday at 01:30 UTC)
#
# NO manual trigger - use CI.yml instead.
# =============================================================================

name: Analysis

on:
  schedule:
    - cron: '30 1 * * 0' # Run at 01:30 every Sunday

  workflow_call:

permissions:
  contents: read
  security-events: write
  actions: read
  packages: read

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ===========================================================================
  # CodeQL - Security Vulnerability Scanning (Java/Kotlin)
  # ===========================================================================
  codeql-kotlin:
    name: ðŸ›¡ï¸ CodeQL (Java/Kotlin)
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ðŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4
        with:
          languages: java-kotlin
          build-mode: manual
          queries: security-and-quality

      - name: ðŸ”¨ Build for Analysis
        run: ./gradlew assemble --no-daemon

      - name: ðŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4
        with:
          category: java-kotlin

  # ===========================================================================
  # CodeQL - GitHub Actions Workflow Analysis
  # ===========================================================================
  codeql-actions:
    name: ðŸ›¡ï¸ CodeQL (Actions)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4
        with:
          languages: actions
          build-mode: none
          queries: security-and-quality

      - name: ðŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4
        with:
          category: actions

  # ===========================================================================
  # Detekt - Kotlin Static Analysis & Code Smells
  # ===========================================================================
  detekt:
    name: ðŸ” Detekt (Kotlin)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      sarif-valid: ${{ steps.validate.outputs.valid }}
      issues-found: ${{ steps.analyze.outputs.issues_found }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ðŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: ðŸ” Run Detekt Analysis
        id: analyze
        run: |
          if ./gradlew detekt --continue; then
            echo "issues_found=false" >> $GITHUB_OUTPUT
            echo "âœ… Detekt analysis completed without issues"
          else
            echo "issues_found=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Detekt found issues (continuing to upload report)"
          fi

      - name: ðŸ“¦ Merge Detekt SARIF Reports
        if: always()
        run: ./gradlew mergeDetektSarif || true

      - name: ðŸ”Ž Validate SARIF file
        id: validate
        if: always()
        run: |
          SARIF_FILE="build/reports/detekt/merged.sarif"

          if [ ! -f "$SARIF_FILE" ]; then
            echo "âš ï¸ SARIF file not found: $SARIF_FILE"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ ! -s "$SARIF_FILE" ]; then
            echo "âš ï¸ SARIF file is empty: $SARIF_FILE"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if jq empty "$SARIF_FILE" 2>/dev/null; then
            echo "âœ… SARIF file is valid JSON"

            if jq -e '.version and .runs' "$SARIF_FILE" > /dev/null 2>&1; then
              echo "âœ… SARIF file has required structure"
              echo "valid=true" >> $GITHUB_OUTPUT

              RESULTS_COUNT=$(jq '[.runs[].results | length] | add // 0' "$SARIF_FILE")
              echo "ðŸ“Š Found $RESULTS_COUNT issue(s) in SARIF report"
            else
              echo "âš ï¸ SARIF file missing required fields"
              echo "valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ SARIF file is not valid JSON"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload Detekt SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4
        if: always() && steps.validate.outputs.valid == 'true'
        with:
          sarif_file: build/reports/detekt/merged.sarif
          category: detekt
          wait-for-processing: true

      - name: ðŸ“¦ Upload Detekt Reports (Artifacts)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: detekt-reports
          path: |
            **/build/reports/detekt/
          retention-days: 14
          if-no-files-found: warn

  # ===========================================================================
  # Summary - Analysis Results Overview
  # ===========================================================================
  summary:
    name: ðŸ“‹ Analysis Summary
    runs-on: ubuntu-latest
    needs: [codeql-kotlin, codeql-actions, detekt]
    if: always()

    steps:
      - name: ðŸ“ Generate analysis summary
        run: |
          echo "## ðŸ›¡ï¸ Security & Code Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${GITHUB_REF_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Event | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Analysis Jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Language | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | Java/Kotlin | \`${{ needs.codeql-kotlin.result }}\` | Security vulnerabilities & quality |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | Actions | \`${{ needs.codeql-actions.result }}\` | Workflow security analysis |" >> $GITHUB_STEP_SUMMARY
          echo "| Detekt | Kotlin | \`${{ needs.detekt.result }}\` | Code smells & style issues |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š View Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All findings are available in the [Security tab](../../security/code-scanning)." >> $GITHUB_STEP_SUMMARY
