# =============================================================================
# Unified CI Workflow - Orchestrates existing workflows
# =============================================================================
# Runs the full CI pipeline on PR, push, or manual trigger.
# Only CI.yml can be triggered manually.
#
# Flow:
#   Env â”€â”€â–º Lint â”€â”€â–º Build â”€â”€â–º Test â”€â”€â–º Coverage â”€â”€â–º Deploy
#                â””â”€â”€â–º Analysis (parallel)
#
# Deployment Rules:
#   - PR:                  NEVER deploy (should_deploy=false)
#   - push to develop:     ALWAYS deploy to development
#   - push to staging:     ALWAYS deploy to staging
#   - push to master:      ALWAYS deploy to prod
#   - manual trigger:      User chooses (deploy input)
#
# =============================================================================

name: CI

on:
  pull_request:
    branches: [master, develop, staging]
    paths:
      - '**.kt'
      - '**.kts'
      - 'gradle/**'
      - '**/build.gradle.kts'
      - '**.yml'
      - '**.yaml'

  push:
    branches: [master, develop, staging]
    paths:
      - '**.kt'
      - '**.kts'
      - 'gradle/**'
      - '**/build.gradle.kts'
      - '**.yml'
      - '**.yaml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (leave as "auto" to detect from branch)'
        required: true
        type: choice
        default: 'auto'
        options:
          - auto
          - development
          - test
          - staging
          - prod
      deploy:
        description: 'Deploy after CI passes'
        required: true
        type: boolean
        default: false
      skip_tests:
        description: 'Skip tests (for quick deployments)'
        required: true
        type: boolean
        default: false
      clear_cache:
        description: 'Clear Render build cache before deploying'
        required: true
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  deployments: write
  security-events: write
  packages: read
  actions: read

jobs:
  # ===========================================================================
  # Step 1: Resolve Environment using Env.yml
  # ===========================================================================
  env:
    name: ðŸ” Environment
    uses: ./.github/workflows/Env.yml
    with:
      environment: ${{ inputs.environment != 'auto' && inputs.environment || '' }}
    secrets: inherit

  # ===========================================================================
  # Step 1b: Compute deployment flags (needs env outputs)
  # ===========================================================================
  flags:
    name: ðŸš© Flags
    runs-on: ubuntu-latest
    needs: [env]

    outputs:
      environment: ${{ needs.env.outputs.environment }}
      should_deploy: ${{ steps.compute.outputs.should_deploy }}
      should_skip_tests: ${{ steps.compute.outputs.should_skip_tests }}
      should_clear_cache: ${{ steps.compute.outputs.should_clear_cache }}
      is_pr: ${{ steps.compute.outputs.is_pr }}

    steps:
      - name: ðŸš© Compute deployment flags
        id: compute
        run: |
          EVENT_NAME="${{ github.event_name }}"
          ENVIRONMENT="${{ needs.env.outputs.environment }}"
          INPUT_DEPLOY="${{ inputs.deploy }}"
          INPUT_SKIP_TESTS="${{ inputs.skip_tests }}"
          INPUT_CLEAR_CACHE="${{ inputs.clear_cache }}"

          # Determine if this is a PR
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            IS_PR="true"
            BRANCH="${{ github.head_ref }}"
          else
            IS_PR="false"
            BRANCH="${GITHUB_REF_NAME}"
          fi

          # Determine if branch can deploy
          CAN_DEPLOY="false"
          case "$BRANCH" in
            master|main|staging|develop) CAN_DEPLOY="true" ;;
          esac

          # Deployment logic
          SHOULD_DEPLOY="false"
          if [[ "$IS_PR" == "true" ]]; then
            SHOULD_DEPLOY="false"
          elif [[ "$EVENT_NAME" == "push" && "$CAN_DEPLOY" == "true" ]]; then
            SHOULD_DEPLOY="true"
          elif [[ "$EVENT_NAME" == "workflow_dispatch" && "$INPUT_DEPLOY" == "true" && "$CAN_DEPLOY" == "true" ]]; then
            SHOULD_DEPLOY="true"
          fi

          # Skip tests flag
          SHOULD_SKIP_TESTS="false"
          if [[ "$EVENT_NAME" == "workflow_dispatch" && "$INPUT_SKIP_TESTS" == "true" ]]; then
            SHOULD_SKIP_TESTS="true"
          fi

          # Clear cache flag
          SHOULD_CLEAR_CACHE="false"
          if [[ "$EVENT_NAME" == "workflow_dispatch" && "$INPUT_CLEAR_CACHE" == "true" ]]; then
            SHOULD_CLEAR_CACHE="true"
          fi

          echo "is_pr=$IS_PR" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "should_skip_tests=$SHOULD_SKIP_TESTS" >> $GITHUB_OUTPUT
          echo "should_clear_cache=$SHOULD_CLEAR_CACHE" >> $GITHUB_OUTPUT

          echo "âœ… Environment: $ENVIRONMENT"
          echo "âœ… Is PR: $IS_PR"
          echo "âœ… Should deploy: $SHOULD_DEPLOY"
          echo "âœ… Should skip tests: $SHOULD_SKIP_TESTS"

      - name: ðŸ“ Environment summary
        run: |
          echo "## ðŸ” Environment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Event | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Is PR | \`${{ steps.compute.outputs.is_pr }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.env.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Should deploy** | \`${{ steps.compute.outputs.should_deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Should skip tests | \`${{ steps.compute.outputs.should_skip_tests }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Step 2: Lint
  # ===========================================================================
  lint:
    name: ðŸ” Lint
    needs: [flags]
    uses: ./.github/workflows/Lint.yml
    secrets: inherit

  # ===========================================================================
  # Step 3a: Build
  # ===========================================================================
  build:
    name: ðŸ”¨ Build
    needs: [flags, lint]
    uses: ./.github/workflows/Build.yml
    secrets: inherit

  # ===========================================================================
  # Step 3b: Analysis (Parallel to build)
  # ===========================================================================
  analysis:
    name: ðŸ›¡ï¸ Analysis
    needs: [flags, lint]
    uses: ./.github/workflows/Analysis.yml
    secrets: inherit

  # ===========================================================================
  # Step 4: Test (with environment for MongoDB)
  # ===========================================================================
  test:
    name: ðŸ§ª Test
    needs: [flags, build]
    if: needs.flags.outputs.should_skip_tests != 'true'
    uses: ./.github/workflows/Test.yml
    with:
      environment: ${{ needs.flags.outputs.environment }}
    secrets: inherit

  # ===========================================================================
  # Step 5: Coverage
  # ===========================================================================
  coverage:
    name: ðŸ“Š Coverage
    needs: [flags, test]
    if: needs.flags.outputs.should_skip_tests != 'true'
    uses: ./.github/workflows/Coverage.yml
    with:
      environment: ${{ needs.flags.outputs.environment }}
    secrets: inherit

  # ===========================================================================
  # Step 6: Deploy
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy
    needs: [flags, build, test, coverage]
    if: |
      always() &&
      needs.flags.outputs.should_deploy == 'true' &&
      needs.flags.result == 'success' &&
      needs.build.result == 'success' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.coverage.result == 'success' || needs.coverage.result == 'skipped')
    uses: ./.github/workflows/Deploy.yml
    with:
      environment: ${{ needs.flags.outputs.environment }}
      clear_cache: ${{ needs.flags.outputs.should_clear_cache == 'true' }}
    secrets: inherit

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: ðŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [flags, lint, build, analysis, test, coverage, deploy]
    if: always()

    steps:
      - name: ðŸ“ Generate CI summary
        run: |
          echo "## ðŸ”„ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.flags.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Should deploy** | \`${{ needs.flags.outputs.should_deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | \`${{ needs.lint.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | \`${{ needs.build.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Analysis | \`${{ needs.analysis.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | \`${{ needs.test.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | \`${{ needs.coverage.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | \`${{ needs.deploy.result }}\` |" >> $GITHUB_STEP_SUMMARY
