# =============================================================================
# Unified CI Workflow - Orchestrates existing workflows
# =============================================================================
# Runs the full CI pipeline on PR, push, or manual trigger.
# Only CI.yml can be triggered manually.
#
# Flow:
#   Env â”€â”€â–º Lint â”€â”€â–º Build â”€â”€â–º Test â”€â”€â–º Coverage â”€â”€â–º Deploy
#                â””â”€â”€â–º Analysis (parallel)
#
# Deployment Rules:
#   - PR:                  NEVER deploy (should_deploy=false)
#   - push to develop:     ALWAYS deploy to development
#   - push to staging:     ALWAYS deploy to staging
#   - push to master:      ALWAYS deploy to prod
#   - manual trigger:      User chooses (deploy input)
#
# Environment Rules:
#   - PR (any target):     default=development, allowed=[development, test]
#   - push to develop:     default=development, allowed=[development, test]
#   - push to staging:     default=staging, allowed=[development, test, staging]
#   - push to master:      default=prod, allowed=[development, test, staging, prod]
#
# =============================================================================

name: CI

on:
  pull_request:
    branches: [master, develop, staging]
    paths:
      - '**.kt'
      - '**.kts'
      - 'gradle/**'
      - '**/build.gradle.kts'
      - '**.yml'
      - '**.yaml'

  push:
    branches: [master, develop, staging]
    paths:
      - '**.kt'
      - '**.kts'
      - 'gradle/**'
      - '**/build.gradle.kts'
      - '**.yml'
      - '**.yaml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (leave as "auto" to detect from branch)'
        required: true
        type: choice
        default: 'auto'
        options:
          - auto
          - development
          - test
          - staging
          - prod
      deploy:
        description: 'Deploy after CI passes'
        required: true
        type: boolean
        default: false
      skip_tests:
        description: 'Skip tests (for quick deployments)'
        required: true
        type: boolean
        default: false
      clear_cache:
        description: 'Clear Render build cache before deploying'
        required: true
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  deployments: write
  security-events: write
  packages: read
  actions: read

jobs:
  # ===========================================================================
  # Step 1: Resolve and Validate Environment
  # ===========================================================================
  env:
    name: ðŸ” Environment
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ steps.resolve.outputs.environment }}
      branch: ${{ steps.resolve.outputs.branch }}
      can_deploy: ${{ steps.resolve.outputs.can_deploy }}
      is_pr: ${{ steps.resolve.outputs.is_pr }}
      should_deploy: ${{ steps.resolve.outputs.should_deploy }}
      should_skip_tests: ${{ steps.resolve.outputs.should_skip_tests }}
      should_clear_cache: ${{ steps.resolve.outputs.should_clear_cache }}

    steps:
      - name: ðŸ” Resolve and validate environment
        id: resolve
        run: |
          EVENT_NAME="${{ github.event_name }}"
          INPUT_ENV="${{ inputs.environment }}"
          INPUT_DEPLOY="${{ inputs.deploy }}"
          INPUT_SKIP_TESTS="${{ inputs.skip_tests }}"

          echo "ðŸ“Œ Event: $EVENT_NAME"
          echo "ðŸ“Œ Input deploy: '$INPUT_DEPLOY'"
          echo "ðŸ“Œ Input skip_tests: '$INPUT_SKIP_TESTS'"

          # Determine branch and if this is a PR
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            IS_PR="true"
            BRANCH="${{ github.head_ref }}"
            TARGET_BRANCH="${{ github.base_ref }}"
            echo "ðŸ“Œ PR: $BRANCH â†’ $TARGET_BRANCH"
          else
            IS_PR="false"
            BRANCH="${GITHUB_REF_NAME}"
            TARGET_BRANCH=""
            echo "ðŸ“Œ Branch: $BRANCH"
          fi

          echo "ðŸ“Œ Requested environment: ${INPUT_ENV:-'(not set)'}"

          # Determine default and allowed environments
          # PRs ALWAYS default to development with limited environments
          if [[ "$IS_PR" == "true" ]]; then
            DEFAULT_ENV="development"
            ALLOWED_ENVS="development test"
            CAN_DEPLOY="false"
            echo "ðŸ“Œ PR detected - restricting to development/test environments, NO deployment"
          else
            # For push and manual triggers, use branch-based rules
            case "$BRANCH" in
              master|main)
                DEFAULT_ENV="prod"
                ALLOWED_ENVS="development test staging prod"
                CAN_DEPLOY="true"
                ;;
              staging)
                DEFAULT_ENV="staging"
                ALLOWED_ENVS="development test staging"
                CAN_DEPLOY="true"
                ;;
              develop)
                DEFAULT_ENV="development"
                ALLOWED_ENVS="development test"
                CAN_DEPLOY="true"
                ;;
              *)
                DEFAULT_ENV="development"
                ALLOWED_ENVS="development test"
                CAN_DEPLOY="false"
                ;;
            esac
          fi

          # Use input or default (if "auto" or not set)
          if [[ -z "$INPUT_ENV" || "$INPUT_ENV" == "auto" ]]; then
            SELECTED_ENV="$DEFAULT_ENV"
          else
            SELECTED_ENV="$INPUT_ENV"
          fi

          # Validate environment against allowed environments
          VALID=false
          for env in $ALLOWED_ENVS; do
            if [[ "$env" == "$SELECTED_ENV" ]]; then
              VALID=true
              break
            fi
          done

          if [[ "$VALID" != "true" ]]; then
            echo "âŒ ERROR: Environment '$SELECTED_ENV' is not allowed"
            echo ""
            if [[ "$IS_PR" == "true" ]]; then
              echo "ðŸ“‹ PRs are restricted to: $ALLOWED_ENVS"
            else
              echo "ðŸ“‹ Allowed environments for branch '$BRANCH': $ALLOWED_ENVS"
            fi
            echo ""
            echo "Environment rules:"
            echo "  - PR (any):   development, test"
            echo "  - develop:    development, test"
            echo "  - staging:    development, test, staging"
            echo "  - master:     development, test, staging, prod"
            exit 1
          fi

          # =====================================================================
          # DEPLOYMENT LOGIC
          # =====================================================================
          # - PR: NEVER deploy
          # - push to develop/staging/master: ALWAYS deploy
          # - manual (workflow_dispatch): User chooses via inputs.deploy
          # =====================================================================
          SHOULD_DEPLOY="false"

          if [[ "$IS_PR" == "true" ]]; then
            # PRs never deploy
            SHOULD_DEPLOY="false"
            echo "ðŸ“Œ PR - deployment disabled"
          elif [[ "$EVENT_NAME" == "push" && "$CAN_DEPLOY" == "true" ]]; then
            # Push to protected branches always deploys
            SHOULD_DEPLOY="true"
            echo "ðŸ“Œ Push to protected branch - deployment enabled"
          elif [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            # Manual trigger: user chooses
            if [[ "$INPUT_DEPLOY" == "true" && "$CAN_DEPLOY" == "true" ]]; then
              SHOULD_DEPLOY="true"
              echo "ðŸ“Œ Manual trigger with deploy=true - deployment enabled"
            else
              SHOULD_DEPLOY="false"
              echo "ðŸ“Œ Manual trigger with deploy=false or branch cannot deploy - deployment disabled"
            fi
          fi

          # Determine if we should skip tests (only on manual trigger with skip_tests=true)
          SHOULD_SKIP_TESTS="false"
          if [[ "$EVENT_NAME" == "workflow_dispatch" && "$INPUT_SKIP_TESTS" == "true" ]]; then
            SHOULD_SKIP_TESTS="true"
          fi

          # Determine if we should clear cache (only on manual trigger with clear_cache=true)
          SHOULD_CLEAR_CACHE="false"
          if [[ "$EVENT_NAME" == "workflow_dispatch" && "${{ inputs.clear_cache }}" == "true" ]]; then
            SHOULD_CLEAR_CACHE="true"
          fi

          echo "environment=$SELECTED_ENV" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "can_deploy=$CAN_DEPLOY" >> $GITHUB_OUTPUT
          echo "is_pr=$IS_PR" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "should_skip_tests=$SHOULD_SKIP_TESTS" >> $GITHUB_OUTPUT
          echo "should_clear_cache=$SHOULD_CLEAR_CACHE" >> $GITHUB_OUTPUT

          echo ""
          echo "=========================================="
          echo "âœ… Selected environment: $SELECTED_ENV"
          echo "âœ… Branch: $BRANCH"
          echo "âœ… Is PR: $IS_PR"
          echo "âœ… Can deploy: $CAN_DEPLOY"
          echo "âœ… Should deploy: $SHOULD_DEPLOY"
          echo "âœ… Should skip tests: $SHOULD_SKIP_TESTS"
          echo "âœ… Should clear cache: $SHOULD_CLEAR_CACHE"
          echo "âœ… Allowed environments: $ALLOWED_ENVS"
          echo "=========================================="

      - name: ðŸ“ Environment summary
        run: |
          echo "## ðŸ” Environment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Event | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Is PR | \`${{ steps.resolve.outputs.is_pr }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ steps.resolve.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ steps.resolve.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Can deploy | \`${{ steps.resolve.outputs.can_deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Should deploy** | \`${{ steps.resolve.outputs.should_deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Should skip tests | \`${{ steps.resolve.outputs.should_skip_tests }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Step 2: Lint (Entry point for code quality chain)
  # ===========================================================================
  lint:
    name: ðŸ” Lint
    needs: [env]
    uses: ./.github/workflows/Lint.yml
    secrets: inherit

  # ===========================================================================
  # Step 3a: Build (After lint passes)
  # ===========================================================================
  build:
    name: ðŸ”¨ Build
    needs: [env, lint]
    uses: ./.github/workflows/Build.yml
    secrets: inherit

  # ===========================================================================
  # Step 3b: Analysis (Parallel to build, after lint)
  # ===========================================================================
  analysis:
    name: ðŸ›¡ï¸ Analysis
    needs: [env, lint]
    uses: ./.github/workflows/Analysis.yml
    secrets: inherit

  # ===========================================================================
  # Step 4: Test (After build passes, can be skipped on manual trigger)
  # ===========================================================================
  test:
    name: ðŸ§ª Test
    needs: [env, build]
    if: needs.env.outputs.should_skip_tests != 'true'
    uses: ./.github/workflows/Test.yml
    secrets: inherit

  # ===========================================================================
  # Step 5: Coverage (After test passes, skipped if tests skipped)
  # ===========================================================================
  coverage:
    name: ðŸ“Š Coverage
    needs: [env, test]
    if: needs.env.outputs.should_skip_tests != 'true'
    uses: ./.github/workflows/Coverage.yml
    secrets: inherit

  # ===========================================================================
  # Step 6: Deploy (Based on should_deploy output)
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy
    needs: [env, build, test, coverage]
    if: |
      always() &&
      needs.env.outputs.should_deploy == 'true' &&
      needs.env.result == 'success' &&
      needs.build.result == 'success' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.coverage.result == 'success' || needs.coverage.result == 'skipped')
    uses: ./.github/workflows/Deploy.yml
    with:
      environment: ${{ needs.env.outputs.environment }}
      clear_cache: ${{ needs.env.outputs.should_clear_cache == 'true' }}
    secrets: inherit

  # ===========================================================================
  # Summary: Generate CI pipeline summary
  # ===========================================================================
  summary:
    name: ðŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [env, lint, build, analysis, test, coverage, deploy]
    if: always()

    steps:
      - name: ðŸ“ Generate CI summary
        run: |
          echo "## ðŸ”„ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Event | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Is PR | \`${{ needs.env.outputs.is_pr }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.env.outputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ needs.env.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Should deploy** | \`${{ needs.env.outputs.should_deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Should skip tests | \`${{ needs.env.outputs.should_skip_tests }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Environment | \`${{ needs.env.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Lint | \`${{ needs.lint.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 3a | Build | \`${{ needs.build.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 3b | Analysis | \`${{ needs.analysis.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Test | \`${{ needs.test.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Coverage | \`${{ needs.coverage.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 6 | Deploy | \`${{ needs.deploy.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Rules" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | Should Deploy | Environment |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR (any target) | âŒ Never | development |" >> $GITHUB_STEP_SUMMARY
          echo "| push to develop | âœ… Always | development |" >> $GITHUB_STEP_SUMMARY
          echo "| push to staging | âœ… Always | staging |" >> $GITHUB_STEP_SUMMARY
          echo "| push to master | âœ… Always | prod |" >> $GITHUB_STEP_SUMMARY
          echo "| manual trigger | ðŸ”˜ User choice | User choice |" >> $GITHUB_STEP_SUMMARY
