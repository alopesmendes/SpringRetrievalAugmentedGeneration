# =============================================================================
# Deploy Workflow - Render Deployment
# =============================================================================
# Deploys the application to Render (Free Plan: 2 services only)
# This workflow can ONLY be called from CI.yml - no manual trigger.
#
# Render Service Mapping:
#   - development, test â†’ image-rag-dev
#   - staging, prod     â†’ image-rag-prod
#
# =============================================================================

name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
      clear_cache:
        description: 'Clear build cache before deploying'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  deployments: write

jobs:
  # ===========================================================================
  # Resolve Render Service
  # ===========================================================================
  resolve:
    name: ðŸ” Resolve Render Service
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ inputs.environment }}
      render_service: ${{ steps.resolve.outputs.render_service }}

    steps:
      - name: ðŸ” Map environment to Render service
        id: resolve
        run: |
          SELECTED_ENV="${{ inputs.environment }}"

          # Map environment to Render service (2 services only)
          case "$SELECTED_ENV" in
            development|test)
              RENDER_SERVICE="dev"
              ;;
            staging|prod)
              RENDER_SERVICE="prod"
              ;;
            *)
              RENDER_SERVICE="dev"
              ;;
          esac

          echo "render_service=$RENDER_SERVICE" >> $GITHUB_OUTPUT
          echo "âœ… Environment: $SELECTED_ENV"
          echo "âœ… Render service: image-rag-$RENDER_SERVICE"

  # ===========================================================================
  # Deploy to Render
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy to Render (${{ needs.resolve.outputs.render_service }})
    runs-on: ubuntu-latest
    needs: [resolve]
    environment:
      name: ${{ inputs.environment }}
      url: ${{ vars.RENDER_DOMAIN }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ðŸ”§ Resolve Render Service ID
        id: resolve_service
        run: |
          SERVICE_ID="${{ vars.RENDER_SERVICE_ID }}"

          if [[ -z "$SERVICE_ID" ]]; then
            echo "âŒ RENDER_SERVICE_ID is not set for environment '${{ inputs.environment }}'"
            echo ""
            echo "ðŸ“‹ Setup required:"
            echo "1. Go to Repository â†’ Settings â†’ Environments â†’ ${{ inputs.environment }}"
            echo "2. Add variable: RENDER_SERVICE_ID = srv-xxx"
            echo "3. Get the service ID from Render Dashboard URL"
            exit 1
          fi

          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT
          echo "âœ… Using Service ID: ${SERVICE_ID:0:10}..."

      - name: ðŸ”§ Validate Render configuration
        run: |
          if [[ -z "${{ secrets.RENDER_API_KEY }}" ]]; then
            echo "âŒ RENDER_API_KEY is not set in repository secrets"
            echo ""
            echo "ðŸ“‹ Setup required:"
            echo "1. Go to https://dashboard.render.com/u/settings#api-keys"
            echo "2. Generate an API key"
            echo "3. Add to Repository â†’ Settings â†’ Secrets â†’ RENDER_API_KEY"
            exit 1
          fi
          echo "âœ… Render configuration validated"

      - name: ðŸš€ Deploy to Render
        id: deploy
        uses: JorgeLNJunior/render-deploy@5bd1684976d2745e6768f4ef8b8a21067fb0cd6f # v1.4.7
        with:
          service_id: ${{ steps.resolve_service.outputs.service_id }}
          api_key: ${{ secrets.RENDER_API_KEY }}
          clear_cache: ${{ inputs.clear_cache }}
          wait_deploy: true
          github_deployment: true
          deployment_environment: ${{ inputs.environment }}
          github_token: ${{ secrets.PROJECT_TOKEN }}

      - name: ðŸ“ Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Render Service | \`image-rag-${{ needs.resolve.outputs.render_service }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${GITHUB_REF_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | @${GITHUB_ACTOR} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache cleared | \`${{ inputs.clear_cache }}\` |" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ vars.RENDER_DOMAIN }}" ]]; then
            echo "| URL | [${{ vars.RENDER_DOMAIN }}](${{ vars.RENDER_DOMAIN }}) |" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Post-Deployment Verification
  # ===========================================================================
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [resolve, deploy]
    environment: ${{ inputs.environment }}
    if: vars.RENDER_DOMAIN != ''

    steps:
      - name: â³ Wait for service to wake up
        run: |
          echo "Waiting 45 seconds for Render free tier service to wake up..."
          sleep 45

      - name: ðŸ¥ Health check
        run: |
          DOMAIN="${{ vars.RENDER_DOMAIN }}"
          HEALTH_ENDPOINT="${DOMAIN}/actuator/health"

          echo "Checking health at: ${HEALTH_ENDPOINT}"

          for i in {1..6}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${HEALTH_ENDPOINT}" || echo "000")

            if [[ "$HTTP_STATUS" == "200" ]]; then
              echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
              exit 0
            fi

            echo "â³ Attempt $i/6: HTTP $HTTP_STATUS - Retrying in 15 seconds..."
            sleep 15
          done

          echo "âŒ Health check failed after 6 attempts"
          exit 1

      - name: ðŸ“ Verification summary
        if: success()
        run: |
          echo "## âœ… Deployment Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Application is healthy at: \`${{ vars.RENDER_DOMAIN }}\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notify on Failure
  # ===========================================================================
  notify-failure:
    name: ðŸš¨ Notify Failure
    runs-on: ubuntu-latest
    needs: [resolve, deploy]
    if: failure()

    steps:
      - name: ðŸš¨ Create failure summary
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Render Service | \`image-rag-${{ needs.resolve.outputs.render_service }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${GITHUB_REF_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Check [Render Dashboard](https://dashboard.render.com) for build logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify \`RENDER_API_KEY\` is valid in repository secrets" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify \`RENDER_SERVICE_ID\` is set in the \`${{ inputs.environment }}\` environment" >> $GITHUB_STEP_SUMMARY
